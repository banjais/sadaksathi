name: üöÄ Deploy Sadak-Sathi to Firebase Hosting (Auto JSON + i18n)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build & Deploy to Firebase
    runs-on: ubuntu-latest

    env:
      NODE_ENV: production
      VITE_APP_MODE: production
      VITE_ENABLE_OFFLINE_MODE: true
      VITE_DEFAULT_MAP_ENGINE: leaflet
      VITE_DEFAULT_MAP_STYLE: light
      VITE_ENABLE_3D_MODE: true

      # Firebase & API secrets
      VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
      VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
      VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
      VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
      VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
      VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
      VITE_FIREBASE_MEASUREMENT_ID: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}

      VITE_GEMINI_API_KEY: ${{ secrets.VITE_GEMINI_API_KEY }}
      VITE_GOOGLE_MAPS_API_KEY: ${{ secrets.VITE_GOOGLE_MAPS_API_KEY }}
      VITE_WAZE_FEED_URL: ${{ secrets.VITE_WAZE_FEED_URL }}
      VITE_GAS_URL: ${{ secrets.VITE_GAS_URL }}
      VITE_SHEET_ID: ${{ secrets.VITE_SHEET_ID }}
      LANG_TAB: ${{ secrets.LANG_TAB }}
      VITE_OPENWEATHERMAP_API_KEY: ${{ secrets.VITE_OPENWEATHERMAP_API_KEY }}
      VITE_DHM_API_KEY: ${{ secrets.VITE_DHM_API_KEY }}
      VITE_OPEN_METRO_API_KEY: ${{ secrets.VITE_OPEN_METRO_API_KEY }}

      VITE_TTS_ENGINE: google
      VITE_STT_ENGINE: webspeech
      VITE_DEFAULT_VOICE: male
      VITE_DEFAULT_LANGUAGE: en

      VITE_ADMIN_EMAIL: banjays@gmail.com
      VITE_SUPPORT_EMAIL: banjays@gmail.com
      VITE_APP_NAME: Sadak Sathi
      VITE_APP_DESCRIPTION: Your Smart Road Companion

      # Output directories
      VITE_I18N_OUTPUT_DIR: ./public/i18n
      VITE_JSON_OUTPUT_DIR: ./public/data

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: üß© Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js
      - name: üß∞ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # 3Ô∏è‚É£ Install dependencies
      - name: üì¶ Install Dependencies
        run: |
          npm ci || npm install
          npm install -g ts-node

      # 4Ô∏è‚É£ Generate JSON & i18n files
      - name: üîÑ Generate JSON Data & i18n Files
        run: |
          echo "Generating JSON and i18n data..."
          mkdir -p ./public/data ./public/i18n
          ts-node --esm src/helpers/json/generate-data-json.ts || echo "Skipping data JSON generation"
          ts-node --esm src/helpers/json/generate-i18n-json.ts || echo "Skipping i18n generation"

      # 5Ô∏è‚É£ Build Vite App
      - name: üèóÔ∏è Build Application
        run: npm run build

      # 6Ô∏è‚É£ Deploy to Firebase Hosting
      - name: üî• Deploy to Firebase
        uses: w9jds/firebase-action@v13
        with:
          args: deploy --only hosting
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}

      # 7Ô∏è‚É£ Email notification on success
      - name: üìß Notify Deployment Success
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚úÖ Sadak-Sathi Deployment Successful"
          to: banjays@gmail.com
          from: "Sadak Sathi Bot <${{ secrets.EMAIL_USERNAME }}>"
          body: |
            Hello üëã,
            The Sadak-Sathi app was successfully deployed to Firebase Hosting!
            Project ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
            Date: ${{ github.event.head_commit.timestamp }}
            Commit: ${{ github.event.head_commit.message }}

      # 8Ô∏è‚É£ Email notification on failure
      - name: üìß Notify Deployment Failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚ùå Sadak-Sathi Deployment Failed"
          to: banjays@gmail.com
          from: "Sadak Sathi Bot <${{ secrets.EMAIL_USERNAME }}>"
          body: |
            Hello üëã,
            The Sadak-Sathi deployment has failed.
            Please check GitHub Actions logs for details.
