name: Build & Deploy Sadak-Sathi App

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Set up Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: "npm"

      # 3️⃣ Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4️⃣ Create .env file from GitHub secrets
      - name: Create .env file
        run: |
          echo "VITE_APP_NAME=${{ secrets.VITE_APP_NAME }}" >> .env
          echo "VITE_APP_DESCRIPTION=${{ secrets.VITE_APP_DESCRIPTION }}" >> .env
          echo "VITE_APP_MODE=${{ secrets.VITE_APP_MODE }}" >> .env
          echo "VITE_DEFAULT_LANGUAGE=${{ secrets.VITE_DEFAULT_LANGUAGE }}" >> .env
          echo "VITE_DEFAULT_MAP_ENGINE=${{ secrets.VITE_DEFAULT_MAP_ENGINE }}" >> .env
          echo "VITE_DEFAULT_MAP_STYLE=${{ secrets.VITE_DEFAULT_MAP_STYLE }}" >> .env
          echo "VITE_MAP_AVAILABLE_STYLES=${{ secrets.VITE_MAP_AVAILABLE_STYLES }}" >> .env
          echo "VITE_DEFAULT_VOICE=${{ secrets.VITE_DEFAULT_VOICE }}" >> .env
          echo "VITE_ENABLE_3D_MODE=${{ secrets.VITE_ENABLE_3D_MODE }}" >> .env
          echo "VITE_ENABLE_OFFLINE_MODE=${{ secrets.VITE_ENABLE_OFFLINE_MODE }}" >> .env
          echo "VITE_PWA_VERSION=${{ secrets.VITE_PWA_VERSION }}" >> .env

          # Firebase
          echo "VITE_FIREBASE_API_KEY=${{ secrets.VITE_FIREBASE_API_KEY }}" >> .env
          echo "VITE_FIREBASE_APP_ID=${{ secrets.VITE_FIREBASE_APP_ID }}" >> .env
          echo "VITE_FIREBASE_AUTH_DOMAIN=${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}" >> .env
          echo "VITE_FIREBASE_MEASUREMENT_ID=${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}" >> .env
          echo "VITE_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}" >> .env
          echo "VITE_FIREBASE_PROJECT_ID=${{ secrets.VITE_FIREBASE_PROJECT_ID }}" >> .env
          echo "VITE_FIREBASE_STORAGE_BUCKET=${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}" >> .env
          echo "FIREBASE_SERVICE_ACCOUNT='${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'" >> .env

          # APIs
          echo "VITE_GEMINI_API_KEY=${{ secrets.VITE_GEMINI_API_KEY }}" >> .env
          echo "VITE_GOOGLE_MAPS_API_KEY=${{ secrets.VITE_GOOGLE_MAPS_API_KEY }}" >> .env
          echo "VITE_TOMTOM_API_KEY=${{ secrets.VITE_TOMTOM_API_KEY }}" >> .env
          echo "VITE_OPENWEATHERMAP_API_KEY=${{ secrets.VITE_OPENWEATHERMAP_API_KEY }}" >> .env
          echo "VITE_OPEN_METRO_API_KEY=${{ secrets.VITE_OPEN_METRO_API_KEY }}" >> .env
          echo "VITE_DHM_API_KEY=${{ secrets.VITE_DHM_API_KEY }}" >> .env
          echo "VITE_WAZE_FEED_URL=${{ secrets.VITE_WAZE_FEED_URL }}" >> .env
          echo "VITE_WEATHER_PROVIDER=${{ secrets.VITE_WEATHER_PROVIDER }}" >> .env

          # Sheets / GAS
          echo "VITE_GAS_URL=${{ secrets.VITE_GAS_URL }}" >> .env
          echo "VITE_SHEET_ID=${{ secrets.VITE_SHEET_ID }}" >> .env

          # Tabs
          echo "TAB_BRIDGE=${{ secrets.TAB_BRIDGE }}" >> .env
          echo "TAB_ROAD=${{ secrets.TAB_ROAD }}" >> .env
          echo "TAB_TOLL=${{ secrets.TAB_TOLL }}" >> .env
          echo "TAB_USER_REPORTED=${{ secrets.TAB_USER_REPORTED }}" >> .env
          echo "TAB_TRANSLATION=${{ secrets.TAB_TRANSLATION }}" >> .env

          # Admin / Email
          echo "EMAIL_USERNAME=${{ secrets.EMAIL_USERNAME }}" >> .env
          echo "EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}" >> .env
          echo "VITE_ADMIN_EMAIL=${{ secrets.VITE_ADMIN_EMAIL }}" >> .env
          echo "VITE_STT_ENGINE=${{ secrets.VITE_STT_ENGINE }}" >> .env
          echo "VITE_TTS_ENGINE=${{ secrets.VITE_TTS_ENGINE }}" >> .env
          echo "VITE_SUPPORT_EMAIL=${{ secrets.VITE_SUPPORT_EMAIL }}" >> .env

      # 5️⃣ Build project
      - name: Build project
        run: npm run build

      # 6️⃣ Upload build artifacts (optional, only on successful build)
      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: sadak-sathi-build
          path: dist/

      # 7️⃣ Deploy to Firebase Hosting
      - name: Deploy to Firebase Hosting
        uses: w9jds/firebase-action@v2.2.0
        with:
          args: deploy --only hosting
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
