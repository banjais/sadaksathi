name: Build & Deploy Sadak-Sathi App

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  lint-and-test:
    name: Lint & Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20.x]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"
      - run: npm ci
      - run: npm run lint
      - run: npm test

  build:
    name: Build Project
    runs-on: ubuntu-latest
    needs: lint-and-test
    strategy:
      matrix:
        node-version: [20.x]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"
      - run: npm ci

      # ğŸ” Create .env file from all secrets
      - name: Create .env file
        run: |
          echo "VITE_APP_NAME=${{ secrets.VITE_APP_NAME }}" >> .env
          echo "VITE_APP_DESCRIPTION=${{ secrets.VITE_APP_DESCRIPTION }}" >> .env
          echo "VITE_APP_MODE=${{ secrets.VITE_APP_MODE }}" >> .env
          echo "VITE_DEFAULT_LANGUAGE=${{ secrets.VITE_DEFAULT_LANGUAGE }}" >> .env
          echo "VITE_DEFAULT_MAP_ENGINE=${{ secrets.VITE_DEFAULT_MAP_ENGINE }}" >> .env
          echo "VITE_DEFAULT_MAP_STYLE=${{ secrets.VITE_DEFAULT_MAP_STYLE }}" >> .env
          echo "VITE_MAP_AVAILABLE_STYLES=${{ secrets.VITE_MAP_AVAILABLE_STYLES }}" >> .env
          echo "VITE_DEFAULT_VOICE=${{ secrets.VITE_DEFAULT_VOICE }}" >> .env
          echo "VITE_ENABLE_3D_MODE=${{ secrets.VITE_ENABLE_3D_MODE }}" >> .env
          echo "VITE_ENABLE_OFFLINE_MODE=${{ secrets.VITE_ENABLE_OFFLINE_MODE }}" >> .env
          echo "VITE_PWA_VERSION=${{ secrets.VITE_PWA_VERSION }}" >> .env

          # Firebase
          echo "VITE_FIREBASE_API_KEY=${{ secrets.VITE_FIREBASE_API_KEY }}" >> .env
          echo "VITE_FIREBASE_APP_ID=${{ secrets.VITE_FIREBASE_APP_ID }}" >> .env
          echo "VITE_FIREBASE_AUTH_DOMAIN=${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}" >> .env
          echo "VITE_FIREBASE_MEASUREMENT_ID=${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}" >> .env
          echo "VITE_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}" >> .env
          echo "VITE_FIREBASE_PROJECT_ID=${{ secrets.VITE_FIREBASE_PROJECT_ID }}" >> .env
          echo "VITE_FIREBASE_STORAGE_BUCKET=${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}" >> .env
          echo "FIREBASE_SERVICE_ACCOUNT='${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'" >> .env

          # APIs
          echo "VITE_GEMINI_API_KEY=${{ secrets.VITE_GEMINI_API_KEY }}" >> .env
          echo "VITE_GOOGLE_MAPS_API_KEY=${{ secrets.VITE_GOOGLE_MAPS_API_KEY }}" >> .env
          echo "VITE_TOMTOM_API_KEY=${{ secrets.VITE_TOMTOM_API_KEY }}" >> .env
          echo "VITE_OPENWEATHERMAP_API_KEY=${{ secrets.VITE_OPENWEATHERMAP_API_KEY }}" >> .env
          echo "VITE_OPEN_METRO_API_KEY=${{ secrets.VITE_OPEN_METRO_API_KEY }}" >> .env
          echo "VITE_DHM_API_KEY=${{ secrets.VITE_DHM_API_KEY }}" >> .env
          echo "VITE_WAZE_FEED_URL=${{ secrets.VITE_WAZE_FEED_URL }}" >> .env
          echo "VITE_WEATHER_PROVIDER=${{ secrets.VITE_WEATHER_PROVIDER }}" >> .env

          # Sheets / GAS
          echo "VITE_GAS_URL=${{ secrets.VITE_GAS_URL }}" >> .env
          echo "VITE_SHEET_ID=${{ secrets.VITE_SHEET_ID }}" >> .env

          # Tabs
          echo "TAB_BRIDGE=${{ secrets.TAB_BRIDGE }}" >> .env
          echo "TAB_ROAD=${{ secrets.TAB_ROAD }}" >> .env
          echo "TAB_TOLL=${{ secrets.TAB_TOLL }}" >> .env
          echo "TAB_USER_REPORTED=${{ secrets.TAB_USER_REPORTED }}" >> .env
          echo "TAB_TRANSLATION=${{ secrets.TAB_TRANSLATION }}" >> .env

          # Admin / Email
          echo "EMAIL_USERNAME=${{ secrets.EMAIL_USERNAME }}" >> .env
          echo "EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}" >> .env
          echo "VITE_ADMIN_EMAIL=${{ secrets.VITE_ADMIN_EMAIL }}" >> .env
          echo "VITE_STT_ENGINE=${{ secrets.VITE_STT_ENGINE }}" >> .env
          echo "VITE_TTS_ENGINE=${{ secrets.VITE_TTS_ENGINE }}" >> .env
          echo "VITE_SUPPORT_EMAIL=${{ secrets.VITE_SUPPORT_EMAIL }}" >> .env

      - run: npm run build

      # ğŸ“¦ Upload build artifact for reuse
      - uses: actions/upload-artifact@v4
        with:
          name: sadak-sathi-build
          path: dist/

  deploy-preview:
    name: Deploy Preview (PR)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: build
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: sadak-sathi-build
      - uses: w9jds/firebase-action@v2.2.1
        with:
          args: deploy --only hosting:preview,functions
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      - name: Post PR Comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            âœ… **Preview deployed successfully!**
            ğŸ”— [Open Preview](https://${{ secrets.VITE_FIREBASE_PROJECT_ID }}.web.app)

  deploy-production:
    name: Deploy Production (Hosting + Functions)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: build
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: sadak-sathi-build
      - uses: w9jds/firebase-action@v2.2.1
        with:
          args: deploy --only hosting,functions
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

      # ğŸ“œ Generate Changelog
      - name: Generate Changelog
        id: changelog
        run: |
          git fetch --prune --unshallow || true
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            git log -10 --pretty=format:"%h - %s (%an)" > changelog.txt
          else
            git log $LAST_TAG..HEAD --pretty=format:"%h - %s (%an)" > changelog.txt
          fi
          cat changelog.txt

      # ğŸ“§ Send Deployment Notification Email
      - name: Send Deployment Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ğŸš€ Sadak-Sathi App Deployed Successfully"
          to: ${{ secrets.EMAIL_TO }}
          from: "Sadak-Sathi CI/CD Bot <${{ secrets.EMAIL_USERNAME }}>"
          body: |
            âœ… **Sadak-Sathi Deployment Completed**

            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}

            App URL: https://${{ secrets.VITE_FIREBASE_PROJECT_ID }}.web.app
            Deployment Time: ${{ github.run_started_at }}

            ğŸ”¹ **Changelog (last commits):**
            $(cat changelog.txt)

            -- 
            Sadak-Sathi DevOps Bot ğŸŒ
